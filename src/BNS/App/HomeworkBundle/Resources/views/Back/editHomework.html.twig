{% extends 'BNSAppHomeworkBundle:Back:layout.html.twig' %}

{% block header %}
	<div class="header-buttons">
		<div class="inner-header">
			<div class="container container-fluid">
				<div class="row-fluid">
					<div class="span6">
						<a href="{{ path('BNSAppHomeworkBundle_back') }}" class="btn bns-notice btn-24 medium-return button-return"><span class="icons-24 back-icon"></span><strong>Retourner</strong> <br> à la liste des travaux</a>
					</div>
					<div class="span6 align-right">
						<a href="#" class="btn bns-success validate-medium btn-24 medium submit-savecontinue-homework"><span class="icons-24 validate-icon"></span><strong>Enregistrer et continuer</strong></a>
						<a href="#" class="btn bns-success validate-medium btn-24 medium submit-save-homework"><span class="icons-24 validate-icon"></span><strong>J'ai terminé</strong></a>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block surround_form_start %}
    <form id="add-homework-form" action="
    {% if homework.slug is empty %}
        {{ path('BNSAppHomeworkBundle_back_add_homework') }}
    {% else %}
        {{ path('BNSAppHomeworkBundle_back_save_homework', {'slug': homework.slug}) }}
    {% endif %}
    " method="post" {{ form_enctype(homework_form) }}>
              
	{% form_theme homework_form _self %}
{% endblock surround_form_start %}
			  
{% block sidebar %}
	<div class="section active">
		Travail
		<span class="shadow-section"></span>
	</div>
	{#{% include 'BNSAppHomeworkBundle:Block:load_subject_block.html.twig' with {'subjects': subjects} %}#}
	<div class="title-container">
        <div class="title active border-blue">Matière<span class="square icon-arrow"></span></div>
		<div class="content-category">
		   <ol>
			   {% for subjectField in homework_form.subject_id %}
				   <li><div>{{ subjectField.vars.label }}{{ form_widget(subjectField, {'attr': {'class': 'pull-right'} }) }}</div></li>
			   {% endfor %}
			   {#{{ form_widget(homework_form.subject_id) }}#}
		   </ol>
	   </div>
	</div>
    <div class="title-container">
        <div class="title active border-blue">Classe(s)<span class="square icon-arrow"></span></div>
		{{ form_errors(homework_form.groups) }}
		<div class="content-category homework-classrooms-filters">
			<ol>
				{% for groupField in homework_form.groups %}
					<li><div>{{ groupField.vars.label }} {{ form_widget(groupField, {'attr': {'class': 'pull-right'} }) }}</div></li>
				{% endfor %}
			</ol>
		</div>
    </div>
	<div class="container-section">
		<div class="section">
			<a href="{{ path('BNSAppHomeworkBundle_back_preferences') }}">Personnalisation</a>
		</div>
	</div>
{% endblock sidebar %}

{% block content %}
	<div class="header-form">
		<p>Rédiger un travail</p>
	</div>
	<div class="content-form-manager">
		<div class="padding-form">
			{{ form_errors(homework_form.name) }}
			{{ form_widget(homework_form.name, {'attr': {'placeholder': 'Intitulé du travail'} }) }}
		</div>
		<div class="date padding-form">
			{{ form_errors(homework_form.date) }}
			{{ form_widget(homework_form.date) }}
		</div>
		<div class="recurrence padding-form">
			<input type="checkbox" id="is-recurrence" />Est un travail récurrent

			<div id="toggle-recurrence" style="display:none;" class="toggle-recurrence">
				<div class="shadow"></div>
				<div>
					<div class="label-recurrence">Type de récurrence</div>
					{{ form_errors(homework_form.recurrence_type) }}
					{{ form_widget(homework_form.recurrence_type) }}
				</div>
				<div id="recurrence_container">
					<div class="label-recurrence">Jours de récurrence</div>
					{{ form_errors(homework_form.recurrence_days) }}
					{{ form_widget(homework_form.recurrence_days) }}
				</div>
				<div id="recurence-end">
					<div class="label-recurrence">Date de fin de récurrence</div>
					{{ form_errors(homework_form.recurrence_end_date) }}
					{{ form_widget(homework_form.recurrence_end_date) }}
				</div>
			</div>
		</div>

		<div class="padding-form">
			{{ form_errors(homework_form.description) }}
			{{ form_widget(homework_form.description, { 'attr': {'class': 'load_tinymce', 'data-theme': 'simple', 'placeholder': 'Ecrire  travail'} }) }}
		</div>

		{% include 'BNSAppResourceBundle:Front:joinedResources.html.twig' with {'resources': homework.getResourceAttachments,"editable": true} %}

		<div class="padding-form">
			{{ form_errors(homework_form.helptext) }}
			{{ form_widget(homework_form.helptext, {'attr': {'placeholder': 'Ecrire une aide pour le travail'} }) }}
		</div>

		{% set homework = homework_form.vars.value %}

		{{ form_rest(homework_form) }}
		{% set homework = homework_form.vars.value %}
		{% include 'BNSAppResourceBundle:Front:joinedResources.html.twig' with {'resources': homework.getResourceAttachments,"editable": true} %}

		{{ form_rest(homework_form) }}
	</div>

{% endblock content %}
	
{% block surround_form_end %}
    </form>
{% endblock surround_form_end %}


{% block main_javascripts %}
    {{ parent() }}
	
	<script type="text/javascript" src="{{ asset('/medias/js/jquery.ui.nestedSortable.js') }}"></script>
{% endblock %}

{% block javascripts %}
	<script src="http://jquery-ui.googlecode.com/svn/tags/latest/ui/minified/i18n/jquery-ui-i18n.min.js" type="text/javascript"></script>
	<script type="text/javascript" src="{{ asset('/medias/js/homework/Back/editHomework.js') }}"></script>	
	<script type="text/javascript" src="{{ asset('/medias/js/homework/subjects.js') }}"></script>
	<script type="text/javascript" src="{{ asset('/medias/js/date.js') }}"></script>
	{{ tinymce_init() }}
	
	<script type="text/javascript">
		$(function ()
		{
			// Filtres catégories
			$('body').on('click', '.homework-classrooms-filters li', function (e)
			{
				var $row = $(e.currentTarget),
					$checkbox = $row.find('.select').first();

				if ($(e.target).parent().hasClass('list-grip')) {
					return;
				}

				// Like radio button, only one checked
				$('.homework-classrooms-filters li .select').removeClass('checked');
				$checkbox.toggleClass('checked');

				// Articles loader
				var $articlesLoader = $('.admin-blog-list .layer');
				$articlesLoader.addClass('show');

				var data = $row.attr('id').split('_'),
					id = data[1];

				$.ajax({
					url: Routing.generate('blog_manager_articles'),
					type: 'POST',
					dataType: 'html',
					data: {'is_enabled': $checkbox.hasClass('checked'), 'category': id},
					success: function (data)
					{
						$('.admin-blog-list .list-articles').html(data);
					}
				}).done(function ()
				{
					$articlesLoader.removeClass('show');
				});

				return false;
			});
		});
	</script>
{% endblock %}