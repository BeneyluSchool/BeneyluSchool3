<script type="text/javascript">
	$(function ()
	{
		// Filters process
		$('.statuses-sidebar-filter').click(function (e)
		{
			$('.statuses-sidebar-filter').removeClass('active');
			var $this = $(e.currentTarget),
				$layer = $('#layer');
				
			$this.addClass('active');
			$layer.addClass('show');
			
			$.ajax({
				url: $this.attr('href'),
				type: 'POST',
				dataType: 'html',
				data: {
					'page': 1,
					'status': $this.data('filter-status')
				},
				success: function (data)
				{
					$('.feeds-list').html(data);
				}
			}).done(function ()
			{
				$layer.removeClass('show');
			});
			
			return false;
		});
		
		// Buttons moderation process
		$('.feed-moderation a').live('click', function (e)
		{
			var $this = $(e.currentTarget),
				$row = $this.parent().parent().parent();
				
			if ($row.hasClass('btn-group')) {
				$row = $row.parent().parent().parent();
			}
			
			var id = $row.attr('id').split('-');
				
			if ($row.hasClass('disabled')) {
				return false;
			}
				
			id = id[1];
			$row.css('opacity', '.4').addClass('disabled');
			var date = $('.feed').last().length > 0 ? $('.feed').last().data('after-date') : null,
				page = $('.pagination').length > 0 ? $('.pagination').data('current-page') : 1;
			
			$.ajax({
				url: '{{ path('profile_manager_moderation_statuses_update') }}',
				type: 'POST',
				dataType: 'json',
				data: {
					'status': $this.data('filter-status'),
					'id': id,
					'date': date,
					'page': page
				},
				success: function (data)
				{
					$data = $(data.feed);
					$data.css('display', 'none');

					if ($('.pagination').length > 0) {
						$('.pagination').before($data);
					}
					else {
						$('.feeds-list').append($data);
					}

					$data.slideDown('slow');
					
					if (data.pager != '') {
						$('.pagination').replaceWith(data.pager);
					}
					else {
						$('.pagination').slideUp('slow');
					}
				}
			}).done(function ()
			{
				$row.slideUp('slow');
			});
			
			return false;
		});
		
		// Pagination process
		$('.pagination a').live('click', function (e)
		{
			var $this = $(e.currentTarget),
				$layer = $('#layer');
			
			$layer.addClass('show');
			setTimeout(function ()
			{
				$layer.find('.message').addClass('bottom');
			}, 50);
			
			$.ajax({
				url: $this.attr('href'),
				type: 'POST',
				dataType: 'html',
				data: {
					'page': $this.data('page'),
					'status': $this.parent().parent().parent().data('status')
				},
				success: function (data)
				{
					$('.feeds-list').html(data);
				}
			}).done(function ()
			{
				$layer.removeClass('show');
				$layer.find('.message').removeClass('bottom');
			});
			
			return false;
		});
		
		// Validate all button process
		$('div.header-buttons .validate-all-statuses').click(function (e)
		{
			var $this = $(e.currentTarget);
			
			if ($this.hasClass('disabled')) {
				return false;
			}
			
			$this.addClass('disabled').attr('disabled', 'disabled');
			$.ajax({
				url: '{{ path('profile_manager_moderation_statuses_validate_all') }}',
				type: 'POST',
				success: function ()
				{
					window.location.reload(true);
				}
			});
			
			return false;
		});
		
		$('.container-sidebar .moderation-statuses').click(function (e)
		{
			var $this = $(e.currentTarget);
			if ($this.hasClass('loading')) {
				return false;
			}

			$this.addClass('loading');

			$.ajax({
				url: $this.attr('href'),
				type: 'POST',
				data: {'state': $this.hasClass('off')},
				success: function (data)
				{
					$this.removeClass('loading');
					$this.toggleClass('off');
				}
			});

			return false;
		});
	});
</script>

<div class="feeds-list-container">
	<div id="layer" class="layer span9 no-margin">
		<div class="message">
			Chargement des statuts en cours
			<div><img src="{{ asset('/medias/images/icons/big-loader.gif') }}" alt=""></div>
		</div>
	</div>
	<div class="feeds-list">
		{% render 'BNSAppProfileBundle:BackModeration:show' with {'page': page} %}
	</div>
</div>